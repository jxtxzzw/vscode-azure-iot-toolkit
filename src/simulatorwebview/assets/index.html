<!DOCTYPE html>
<html>

<head>
    <!-- The loading sequence is critical, and should not be changed,
        otherwise webview may show in blank because some variable cannot get the initial data
        (e.g. axios.js is missing so that we can't do POST in main.js ) -->
    <link rel="stylesheet" href="{{root}}/src/simulatorwebview/assets/main.css">
    <link rel="stylesheet" href="./main.css">
    <link rel="stylesheet" href="{{root}}/src/simulatorwebview/assets/iview.css">
    <link rel="stylesheet" href="./iview.css">
    <script type="text/javascript" src="{{root}}/src/simulatorwebview/assets/axios.min.js"></script>
    <script type="text/javascript" src="./axios.min.js"></script>
    <script type="text/javascript" src="{{root}}/src/simulatorwebview/assets/vue.min.js"></script>
    <script type="text/javascript" src="./vue.min.js"></script>
    <!-- v-cloak will remain on the element until the associated Vue instance finishes compilation.
        Combined with CSS rules, this directive can be used to hide un-compiled mustache bindings until the Vue instance is ready.  -->
    <style type="text/css">
        [v-cloak] {
          display: none !important;
        }
    </style>
</head>

<body>
    <div id="app" data-endpoint="{{endpoint}}" v-cloak>
        <Row>
            <i-col span="15">
                <Card :dis-hover="true" :bordered="false">
                    <Row>
                        <i-col span="24">
                            <h1>
                                IoT Device Simulator
                            </h1>
                            <p>
                                {{ introduction }}
                            </p>
                            <br/>
                            <p>
                                You are sending message(s) to <b>{{ hostName }}</b>
                            </p>
                            <br/>
                        </i-col>
                    </Row>
                    <i-form ref="formItem" :model="formItem" :rules="ruleValidation">
                        <form-item prop="deviceConnectionStrings" label="Device(s) to simulate">
                            <Row>
                                <i-col span="24">
                                    <i-select
                                        v-model="formItem.deviceConnectionStrings"
                                        multiple
                                        filterable
                                        placeholder="Please select the device(s) you want to send message from..."
                                        not-found-text="No Device Found"
                                        @on-change="persistInputs"
                                        >
                                        <i-option
                                            v-for="item in inputDeviceList"
                                            :value="item.connectionString"
                                            :key="item.connectionString"
                                            >
                                            {{ item.label }}
                                        </i-option>
                                    </i-select>
                                </i-col>
                            </Row>
                        </form-item>
                        <Row>
                            <i-col span="7">
                                <form-item prop="numbers" label="Message numbers per device">
                                    <i-input v-model="formItem.numbers" placeholder="Number of messages for per device" @on-change="persistInputs"></i-input>
                                </form-item>
                            </i-col>
                            <i-col span="10" offset="1">
                                <form-item prop="interval" label="Interval">
                                    <i-input v-model="formItem.interval" placeholder="Interval between two messages" @on-change="persistInputs">
                                        <i-select v-model="intervalUnit" slot="append" style="width: 150px" @on-change="persistInputs">
                                            <i-option value="millisecond">millisecond(s)</i-option>
                                            <i-option value="second">second(s)</i-option>
                                            <i-option value="minute">minute(s)</i-option>
                                        </i-select>
                                    </i-input>
                                </form-item>
                            </i-col>
                        </Row>
                        <form-item prop="messageBody" label="Message Body">
                            <Row>
                                <i-col span="24">
                                    <radio-group v-model="messageBody" @on-change="messageBodyChange">
                                        <Radio label="Plain Text">Plain Text</Radio>
                                        <Radio label="Dummy Json">Dummy Json</Radio>
                                    </radio-group>
                                </i-col>
                            </Row>
                        </form-item>
                        <form-item prop="message" label="Message" >
                            <a v-if="messageBody=='Dummy Json'" href="https://github.com/webroo/dummy-json">
                                Click here to see advanced usage.
                                <Icon type="md-open"></Icon>
                            </a>
                        <Row>
                            <i-col span="24">
                                <Tabs v-model="messageInputAreaTab" @on-click="textAreaOnChange" :animated="false">
                                    <tab-pane label="Write" name="Write">
                                        <i-input
                                            v-if="messageBody=='Plain Text'"
                                            v-model="textArea.plainTextArea"
                                            style="width: 100%"
                                            @on-change="textAreaOnChange"
                                            placeholder="Enter the message content here..."
                                            type="textarea"
                                            :autosize="{minRows: 10,maxRows: 10}">
                                        </i-input>
                                        <i-input
                                            v-if="messageBody=='Dummy Json'"
                                            v-model="textArea.dummyJsonArea"
                                            style="width: 100%"
                                            @on-change="textAreaOnChange"
                                            placeholder="Enter the dummy-json template here..."
                                            type="textarea"
                                            :autosize="{minRows: 10,maxRows: 10}">
                                        </i-input>
                                    </tab-pane>
                                    <tab-pane v-if="messageBody=='Dummy Json'" label="Preview" name="Preview">
                                        <i-input
                                            style="width: 100%"
                                            v-model="textArea.generatedMessage"
                                            readonly
                                            type="textarea"
                                            :autosize="{minRows: 10,maxRows: 10}">
                                        </i-input>
                                    </tab-pane>   
                                </Tabs>
                            </i-col>
                        </Row>
                        </form-item>
                        <form-item>
                            <i-button :disabled="status.isProcessing" type="primary" @click="send()"> {{ status.isProcessing ? 'A previous simulation is in progress, please wait or cancel it.' : 'Start simulation'}}</i-button>
                        </form-item>
                    </i-form>
                </Card>
            </i-col>
        </Row>
        <Modal v-model="status.isProcessing" width="380" :mask-closable="false" :closable="false">
            <p slot="header" style="text-align:center">
                <Icon type="ios-information-circle"></Icon>
                <span>A simulation is in progress...</span>
            </p>
            <div style="text-align:center">
                <p>The simulator has already sent <b>{{status.numberOfSentMessage}}</b> of the {{status.numberOfTotalMessage}} message(s).</p>
                <i-progress
                status="active"
                :percent="Math.round(this.status.numberOfSentMessage / this.status.numberOfTotalMessage * 100)">
                </i-progress>
                <p><b>{{status.numberOfSuccessfulMessage}}</b> of them are successfully sent:</p>
                <i-progress
                stroke-color="#19be6b"
                hide-info
                :percent="Math.round(this.status.numberOfSuccessfulMessage / this.status.numberOfTotalMessage * 100)">
                </i-progress>
                <p><b>{{status.numberOfFailedMessage}}</b> of them are failed:</p>
                <i-progress
                stroke-color="#ed4014"
                hide-info
                :percent="Math.round(this.status.numberOfFailedMessage / this.status.numberOfTotalMessage * 100)">
                </i-progress>
                <p>The status of the remaining messages is still pending.</p>
            </div>
            <div slot="footer">
                <i-button type="error" size="large" long @click="progressCancel">Cancel</i-button>
            </div>
        </Modal>
    </div>
    <!-- The loading sequence is critical, iview.js must be executed before main.js,
        otherwise unexpected placeholder will show on the page before they get properly rendered -->
    <script type="text/javascript" src="{{root}}/src/simulatorwebview/assets/iview.min.js"></script>
    <script type="text/javascript" src="./iview.min.js"></script>
    <script type="text/javascript" src="{{root}}/src/simulatorwebview/assets/main.js"></script>
    <script type="text/javascript" src="./main.js"></script>
</body>

</html>